#MAC = [250]
#PHENOTYPES = ['ciprofloxacin', 'ampicillin', 'cefotaxime', 'ceftazidime', 'gentamicin', 'amoxicillin.clavulanic.acid', 'piperacillin.tazobactam','trimethoprim.sulfamethoxazole']
PHENOTYPES = ['ampicillin','ciprofloxacin', 'trimethoprim.sulfamethoxazole']
#PHENOTYPES = ['cefotaxime','ceftazidime']

#outlier_samples = ["^ERR1218638,ERR1218722,ERR4035496,ERR4037257,SRR10271534,SRR10272173,SRR10272272,SRR10272285,SRR10272401,SRR2449168,SRR3588897,SRR3932419,SRR3982215,SRR850803"]

#PLINK_OUT_PREFIX =

wildcard_constraints:
    pheno="|".join(PHENOTYPES),



rule all:
    input:
        "output/annotated_output_MAF250_presence_absence_all.cXX.txt",
        expand("plink/annotated_output_MAF250_presence_absence_all_{pheno}.bed", pheno = PHENOTYPES),
        expand("plink/annotated_output_MAF250_presence_absence_all_{pheno}.fam", pheno = PHENOTYPES),
        expand("output/annotated_output_MAF250_presence_absence_all_{pheno}_bslmm_blup.param.txt", pheno = PHENOTYPES),
        expand("output/annotated_output_MAF250_presence_absence_all_{pheno}_bslmm_probit.param.txt", pheno = PHENOTYPES)



#ruleorder: run_GEMMA_gwas > edit_plink_fam > plink_generate_input > filter_variants


#generate phenotype files
rule edit_plink_fam:
    input:
        "plink/annotated_output_MAF250_presence_absence_all.fam"
    output:
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.fam"
    params:
        "{pheno}"
    conda:
        "popgenR"
    script:
        "gwas_plink_fam_edit.R"



#generate GEMMA relatedness matrix
rule run_GEMMA_relmatrix:
    input:
        "plink/annotated_output_MAF250_presence_absence_all.bed"
    output:
        "output/annotated_output_MAF250_presence_absence_all.cXX.txt"
    conda:
        "popgenR"
    shell:
        """
        sed -i 's/-9/1/g' plink/annotated_output_MAF250_presence_absence_all.fam
        gemma -bfile plink/annotated_output_MAF250_presence_absence_all  -gk 1 -o annotated_output_MAF250_presence_absence_all
        """


#create temp gemma input files
rule GEMMA_temp_files:
    input:
         "plink/annotated_output_MAF250_presence_absence_all.bed",
         "plink/annotated_output_MAF250_presence_absence_all.bim"
    output:
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.bed",
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.bim"
    params:
        "{pheno}"
    conda:
        "popgenR"
    shell:
        """
        cp plink/annotated_output_MAF250_presence_absence_all.bed plink/annotated_output_MAF250_presence_absence_all_{wildcards.pheno}.bed
        cp plink/annotated_output_MAF250_presence_absence_all.bim plink/annotated_output_MAF250_presence_absence_all_{wildcards.pheno}.bim
        """


#run GEMMA genopred
rule run_GEMMA_gwas:
    input:
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.bed",
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.fam",
        "output/annotated_output_MAF250_presence_absence_all.cXX.txt"
    output:
        "output/annotated_output_MAF250_presence_absence_all_{pheno}_bslmm_blup.param.txt"
    #params:
    #    "{pheno}"
    conda:
        "popgenR"
    threads:8
    shell:
        """
        gemma -bfile plink/annotated_output_MAF250_presence_absence_all_{wildcards.pheno} -bslmm 2  -o annotated_output_MAF250_presence_absence_all_{wildcards.pheno}_bslmm_blup -k "output/annotated_output_MAF250_presence_absence_all.cXX.txt"
        """

#run GEMMA genopred probit
rule run_GEMMA_gwas_probit:
    input:
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.bed",
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.bim",
        "plink/annotated_output_MAF250_presence_absence_all_{pheno}.fam",
        "output/annotated_output_MAF250_presence_absence_all.cXX.txt"
    output:
         "output/annotated_output_MAF250_presence_absence_all_{pheno}_bslmm_probit.param.txt"
    params:
        "{pheno}"
    conda:
        "popgenR"
    threads:13
    shell:
        """
        gemma -bfile plink/annotated_output_MAF250_presence_absence_all_{wildcards.pheno} -bslmm 3  -o annotated_output_MAF250_presence_absence_all_{wildcards.pheno}_bslmm_probit -k "output/annotated_output_MAF250_presence_absence_all.cXX.txt"
        """
